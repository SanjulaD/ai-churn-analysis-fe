name: ğŸ³ Docker CI/CD Pipeline

on:
  push:
    branches: [test]
  pull_request:
    branches: [test]

env:
  IMAGE_NAME: ai-churn-analysis-dashboard

jobs:
  build-and-test:
    name: ğŸ§ª Build & Test with Docker
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ³ Build Docker Image
        run: docker build -t $IMAGE_NAME .

      - name: ğŸš€ Run Tests in Docker
        run: docker run --rm $IMAGE_NAME npm test

      - name: Save Docker Image as artifact
        run: docker save $IMAGE_NAME -o $IMAGE_NAME.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: $IMAGE_NAME.tar

  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: Download Docker image artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
          path: .

      - name: Load Docker image
        run: docker load -i $IMAGE_NAME.tar

      - name: ğŸ“¦ Copy Build Files
        run: |
          docker create --name extract $IMAGE_NAME
          docker cp extract:/app/dist ./dist
          docker rm -f extract

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
